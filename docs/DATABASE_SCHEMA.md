# Database Schema

* **Type:** InnoDB
* **Encoding:** UTF-8 Unicode (utf8)
* **Collation:** utf8_general_ci

# Tables
******************************************************************************************************************

database_version
-------------------------
Holds the current database version to allow the system to work out whether its database requires upgrading.

* **database_version** - Database version integer

* **PRIMARY** key on **database_version**

```sql
CREATE TABLE `database_version` (
  `database_version` bigint(20) unsigned NOT NULL,
  PRIMARY KEY (`database_version`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

permissions
-------------------------
Permissions available on the app for performing various actions and requests

* **id** - Primary key identifier
* **type** - String describing the type of permission (e.g. sysadmin)
* **name** - String used to identify the permission when checking for it, and when granting it in the sysadmin panel
* **description** - String describing what the permission is for

* **PRIMARY** key on **id**
* **UNIQUE** key on **name**

```sql
CREATE TABLE `permissions` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `type` varchar(16) NOT NULL,
  `name` varchar(32) NOT NULL,
  `description` varchar(128) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

user_groups_permissions
-------------------------
Holds the map of user groups to permissions and the status they have been given regarding them (granted, not granted, never granted)

* **group_id** - User group
* **permission_id** - Permission
* **granted** - Grant status of permission, constants are defined in the UserGroupPermission model

* **UNIQUE** key on **group_id, permission_id**

```sql
CREATE TABLE `user_groups_permissions` (
  `group_id` bigint(20) unsigned NOT NULL,
  `permission_id` bigint(20) unsigned NOT NULL,
  `granted` tinyint(4) NOT NULL,
  UNIQUE KEY `group_permission` (`group_id`,`permission_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

users
-------------------------
Holds all users

* **id** - Primary key identifier
* **email** - Email
* **password_hash** - Password hash, generated by PHP password_* library
* **full_name** - Full name
* **phone_number** - Telephone number
* **group_id** - Assigned user group
* **organization_id** - Organization

```sql
CREATE TABLE `users` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `email` varchar(254) NOT NULL,
  `password_hash` varchar(255) NOT NULL,
  `full_name` varchar(64) NOT NULL,
  `phone_number` varchar(32) NOT NULL,
  `group_id` bigint(20) unsigned NOT NULL,
  `organization_id` bigint(20) unsigned DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

user_groups
-------------------------
Holds all user groups

* **id** - Primary key identifier
* **name** - Group name
* **special** - Prevents deletion of the group (i.e. system group)

```sql
CREATE TABLE `user_groups` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(64) NOT NULL,
  `special` tinyint(1) unsigned NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

autologins
-------------------------
Holds all autologins ('remember me's)

* **id** - Primary key identifier
* **user_id** - User
* **browser_parameters_hash** - SHA256 hash of the browser parameters, i.e. some uniquely identifying information about the browser, which if change should invalidate the autologin
* **key_hash** - password_hash() of a randomly generated key that will be stored in the browser
* **epoch_created** - Epoch of when the autologin was created
* **epoch_last_used** - Epoch of when the autologin was last successfully used

```sql
CREATE TABLE `autologins` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) unsigned NOT NULL,
  `browser_parameters_hash` char(64) NOT NULL,
  `key_hash` varchar(255) NOT NULL,
  `epoch_created` bigint(20) unsigned NOT NULL,
  `epoch_last_used` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`id`),
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```